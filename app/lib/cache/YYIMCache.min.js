var YYIMCacheSpaceManager=function(){function t(){this.list={}}function e(t){this.members=[],this.list={},this.loadedMembers=!1,this.build(t)}function s(){this.init()}function i(t){this.build(t)}function n(t){this.build(t)}function o(){this.messList={},this.showInterval={},this.atUserList=[],this.attachMapped={}}function a(t){this.defaultAvatar=y.STATICADDRESS+E.DEFAULT_PHOTO.ROSTER,this.build(t)}function r(t){this.build(t)}function c(){}function h(t){this.id=t.id||t.from||this.id,this.presence={},this.build(t)}function d(t){this.loadedInfo=!1,this.build(t)}function p(){this.init()}function u(t){this.build(t)}function l(t){this.list={},this.recentTopList=[],this.recentNormalList=[],this.recentList=[],this.stick=!1,this.spaceIds=[],this.type=E.RECENT_TYPE.FOLDED,this.build(t)}function f(t){this.build(t)}function m(t){this.recentTopList=[],this.recentNormalList=[],this.recentList=[],this.spaceId=t,this.init()}function T(t){this.build(t)}function I(t){}var y={ADDRESS:"http://pc.api.esn.ren:6062",STATICADDRESS:"http://test.staticoss.upesn.com/",VCARDURL:"/user/info/"},g={SPACETYPE:{NORMAL:"normal",DEALER:"dealer"},REVOCATIONMESSAGE:{DELAY:12e4},GROUPTYPE:{TEAM:{flag:"group",name:"team"},APP:{flag:"app",name:"app"},DEALER:{flag:"jgroup",name:"dealer"}},PUBACCOUNTTYPE:{PUBACCOUNT:{name:"pubaccount",type:{app:{photo:"static/images/ico-appnotify.png"},feed:{photo:""},groupnew:{photo:"static/images/ico-teamnotify.png"},system:{photo:""},qz:{photo:"static/images/ico-esnnotify.png"}}},MSGACCOUNT:{name:"msgaccount"},APPACCOUNT:{name:"appaccount"}}},E={IMCHATVERSION:"local_3.0.1",PRE_HISTORY_LENGTH:10,PRE_SHOW_TIMEINTERVAL:3e5,LOCATION_SHOWPIC_SIZE:"320*200",CHAT_TYPE:{CHAT:"chat",GROUP_CHAT:"groupchat",PUB_ACCOUNT:"pubaccount"},SEND_STATE:{NONE:"none",UNREADED:"unreaded",READED:"readed"},ROSTER_TYPE:{MYSELF:"myself",FRIEND:"friend",ASK:"ask",RECV:"recv",NONE:"none"},ROSTER_SUBSCRIPTION_TYPE:{BOTH:"both",NONE:"none"},PUBACCOUNT_TYPE:{SUBSCRIBED:{TYPE:1,NAME:"subscribed"},SUBSCRIBE:{TYPE:1,NAME:"subscribe"},BROADCASE:{TYPE:2,NAME:"broadcase"}},MESSAGE_CONTENT_TYPE:{MIXED:"mixed",SIMPLE:"simple",TEXT:2,FILE:4,IMAGE:8,SMALLVIDEO:10,REVOCATION:13,SYSTEM:16,PUBLIC:32,AUDO:64,LOCATION:128,SHARE:256,WHITEBOARD:1024,NETMEETING:2048},DEFAULT_PHOTO:{DEFAULT:"",ROSTER:"default_avatar.jpg",GROUP:"",GROUPMEMEBER:"",PUBACCOUNT:""},PRESENCE_SHOW:{CHAT:"chat",AWAY:"away",XA:"xa",DND:"dnd",UNAVAILABLE:"unavailable"},TERMINAL_TYPE:{WEB:"web",ANDROID:"android",IOS:"ios",PC:"pc"},MESSAGE_READ_TYPE:{READED:"readed",UNREADED:"unreaded",ALL:"all"},TRAMSPARENT_TYPE:{ATTACHMENTCONVERTED:"attachmentConverted",REVOKE:"revoke",SETMUTE:"setMute",CANCELMUTE:"cancelMute",SETSTICK:"setStick",CANCELSTICK:"cancelStick"},RECENT_TYPE:{UNFOLDED:"unfolded",FOLDED:"folded"}};t.prototype.set=function(t,e){t&&e&&(this.list[t]=e)},t.prototype.get=function(t){return t?this.list[t]:this.list},t.prototype.remove=function(t){t&&delete this.list[t]},t.prototype.update=function(t,e){this.set.apply(this,arguments)},t.prototype.clear=function(){this.list={}},t.prototype.forEach=function(t){if(YYIMUtil.isWhateType(t,"Function")){var e=0;for(var s in this.list)this.list[s].id&&t(e++,this.list[s],this.list)}},e.prototype=new t,e.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name,this.numberOfMembers=t.numberOfMembers||this.numberOfMembers,this.superLarge=t.superLarge||this.superLarge,this.collected=YYIMUtil.isWhateType(t.collected,"Boolean")||YYIMUtil.isWhateType(t.collected,"Number")?!!t.collected:!!this.collected,this.creater=t.creater||this.creater,this.photo=t.photo||this.photo,this.loadedInfo=YYIMUtil.isWhateType(t.loadedInfo,"Boolean")?t.loadedInfo:!!this.loadedInfo,this.loadedMembers=YYIMUtil.isWhateType(t.loadedMembers,"Boolean")?t.loadedMembers:!!this.loadedMembers,this.tag=t.tag||this.tag,this.mute=YYIMUtil.isWhateType(t.mute,"Boolean")?t.mute:!!this.mute,this.stick=YYIMUtil.isWhateType(t.stick,"Boolean")?t.stick:!!this.stick,this.updateMemberList(t.members,t.action),this.syncInfo()},e.prototype.syncInfo=function(){if(this.photo||(this.photo=E.DEFAULT_PHOTO.GROUP),!this.name){this.name=this.name||"";var t=this.members.length<=5?this.members.length:5;if(1==t)this.name="群组";else if(2==t)this.forEach(function(t,e,s){e.id!=YYIMChat.getUserID()&&(this.name=e.name)});else if(t>2)for(var e=0;e<t;e++)this.members[e].id!=YYIMChat.getUserID()?e<t-1?this.name+=this.members[e].name+",":e==t-1&&(this.name+=this.members[e].name):this.members.length>t&&++t}this.getAttributes()},e.prototype.getAttributes=function(){if(this.id&&!this.spaceId){var t=this.id.split("_");if(t.length>1){if(!this.groupType)for(var e in g.GROUPTYPE)if(g.GROUPTYPE[e].flag==t[0]){this.groupType=g.GROUPTYPE[e].name,t[2]&&t[0]==g.GROUPTYPE.TEAM.flag&&(this.teamId=t[2]);break}this.groupType&&(this.spaceId=t[1]||this.spaceId)}}},e.prototype.getPhotoUrl=function(){return this.photo},e.prototype.updateMemberList=function(t,e){if(t&&t.length){"append"!==e&&(this.clear(),this.members.length=0);for(var s in t)if(t[s].id){var i=this.get(t[s].id);t[s].loadedInfo=!0,i?(i.vcard.build(t[s]),i.build(t[s]),p.getInstance().set(i.id,i)):(t[s].vcard=new u(t[s]),i=new d(t[s]),this.set(i.id,i),this.members.push(i),p.getInstance().set(i.id,i)),"owner"===t[s].affiliation&&(this.owner=i)}}},e.prototype.removeMember=function(t){var e=this.get(t);if(e){this.remove(t);var s=this.members.indexOf(e);s>-1&&this.members.splice(s,1),this.numberOfMembers>=1&&(this.numberOfMembers-=1)}},e.prototype.getGroupMembers=function(t){var e=this;t=t||{},this.querying||(this.querying=!0,YYIMChat.getGroupMembers({to:this.id,success:function(s){e.build({members:JSON.parse(s),loadedMembers:!0}),e.querying=!1,t&&t.success&&t.success(e)},error:t.error,complete:t.complete}))},e.prototype.transferOwner=function(t){this.owner=this.get(t)||this.owner},s.prototype=new t,s.getInstance=function(t){return this._instance||(this._instance=new s),this._instance.spaceId=t,this._instance},s.prototype.init=function(t){var e=this;jQuery(window).on("unload",function(){e.save()})},s.prototype.updateCache=function(t){if(t&&t.id){var s=this.get(t.id);return s?s.build(t):(s=new e(t),this.set(s.id,s)),s}},s.prototype.createChatGroup=function(t){var e=this;YYIMChat.createChatGroup({name:t.name,members:t.members||[],success:function(s){t.success&&t.success(e.updateCache(s))},complete:function(){t.complete&&t.complete()}})},s.prototype.createDealerChatGroup=function(t){if(this.spaceId){var e=this;YYIMChat.createChatGroup({to:g.GROUPTYPE.DEALER.flag+"_"+this.spaceId+"_"+(new Date).getTime(),name:t.name,members:t.members||[],success:function(s){t.success&&t.success(e.updateCache(s))},complete:function(){t.complete&&t.complete()}})}},s.prototype.getGroupMembers=function(t){var e=this.get(t.to);e&&e.getGroupMembers(t)},s.prototype.transferChatGroup=function(t){var e=this.get(t.to);if(e.owner&&e.owner.id===YYIMChat.getUserID()){var s=e.get(t.newOwner);if(s){var i=this;YYIMChat.transferChatGroup({to:t.to||t.id,newOwner:t.newOwner,success:function(e){e.action="append",t.success&&t.success(i.updateCache(e))},complete:function(){t.complete&&t.complete()}})}}},s.prototype.dismissChatGroup=function(t){var e=this.get(t.to),s=this;e&&e.owner.id==YYIMChat.getUserID()&&YYIMChat.dismissChatGroup({to:t.to,success:function(e){s.remove(e.from),t.success&&t.success(e.from)},error:t.error,complete:t.complete})},s.prototype.transferOwner=function(t){if(t.to){var e=this.get(t.to);e&&t.newOwner&&e.transferOwner(t.newOwner)}},s.prototype.inviteGroupMember=function(t){var e=this;YYIMChat.inviteGroupMember({to:t.to||t.id,members:t.members||[],success:function(s){t.success&&t.success(e.updateCache(s))},complete:function(){t.complete&&t.complete()}})},s.prototype.modifyChatGroupInfo=function(t){if(this.get(t.to).owner.id===YYIMChat.getUserID()){var e=this;YYIMChat.modifyChatGroupInfo({to:t.to||t.id,name:t.name,success:function(s){t.success&&t.success(e.updateCache(s))},complete:function(){t.complete&&t.complete()}})}},s.prototype.kickGroupMember=function(t){var e=this;YYIMChat.kickGroupMember({to:t.to,member:t.member,success:function(s){t.success&&t.success(e.updateCache(s))},error:t.error,complete:t.complete})},s.prototype.KickedOutByGroup=function(t){var e=this.get(t.from);e&&(t.to&&t.to!==YYIMChat.getUserID()?e.removeMember(t.to):this.remove(t.from))},s.prototype.exitChatGroup=function(t){var e=this;YYIMChat.exitChatGroup({to:t.to,success:function(s){e.remove(s.from),t.success&&t.success(s.from)},complete:function(){t.complete&&t.complete()}})},s.prototype.collectGroup=function(t){var e=this;YYIMChat.collectGroup({to:t.to,success:function(t){e.updateCache({id:t.from,collected:!0})},complete:function(){t.complete&&t.complete()}})},s.prototype.removeCollectGroup=function(t){var e=this;YYIMChat.removeCollectGroup({to:t.to,success:function(t){e.updateCache({id:t.from,collected:!1})},complete:function(){t.complete&&t.complete()}})},s.prototype.getGroupList=function(){var t=[];for(var e in this.list)this.list[e].id&&(this.list[e].spaceId&&this.list[e].spaceId!=this.spaceId||t.push(this.list[e]));return t},s.prototype.initLocal=function(t){t=t||{};var e=Y.localstorage.getItem("GROUPDATA_"+YYIMChat.getUserNode());try{e=JSON.parse(e);for(var s in e)e[s].id&&(e[s].loadedInfo=!0,this.updateCache(e[s]))}catch(i){Y.localstorage.setItem("GROUPTIMESTAMP_"+YYIMChat.getUserNode(),0)}that=this,YYIMChat.getChatGroups({startDate:Number(Y.localstorage.getItem("GROUPTIMESTAMP_"+YYIMChat.getUserNode()))||0,success:function(e){Y.localstorage.setItem("GROUPTIMESTAMP_"+YYIMChat.getUserNode(),e.ts);for(var s in e.roomItems)e.roomItems[s].id&&(e.roomItems[s].loadedInfo=!0,that.updateCache(e.roomItems[s]));that.forEach(function(t,s,i){e.roomNames.indexOf(s.id)===-1&&that.remove(s.id)}),t.success&&t.success()}})},s.prototype.save=function(){var t={};this.forEach(function(e,s,i){var n=[];s.owner&&n.push({id:s.owner.id,name:s.owner.name,photo:s.owner.photo,affiliation:"owner"});for(var o=0;o<10&&o<s.members.length;o++)s.owner&&s.owner.id==s.members[o].id||n.push({id:s.members[o].id,name:s.members[o].name,photo:s.members[o].photo,affiliation:"memeber"});t[s.id]={id:s.id,name:s.name,photo:s.photo,members:n,numberOfMembers:s.numberOfMembers}}),Y.localstorage.setItem("GROUPDATA_"+YYIMChat.getUserNode(),JSON.stringify(t))},s.prototype.destory=function(){this.save(),this.clear()},i.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name||this.id,this.photo=t.photo||this.photo,this.affiliation=t.affiliation||this.affiliation,this.role=t.role||this.role,this.syncInfo()},i.prototype.syncInfo=function(){this.photo?this.photo=y.STATICADDRESS+this.photo:this.photo=E.DEFAULT_PHOTO.GROUPMEMEBER,this.avatar=this.photo},i.prototype.getPhotoUrl=function(){return this.photo},n.prototype.init=function(){this.syncInfo()},n.prototype.build=function(t){this.id=t.msgId||t.packetId||t.id||this.id,this.type=t.type||t.chatType||this.type||E.CHAT_TYPE.CHAT,this.data=t.body||t.data||this.data,this.resource=t.resource||this.resource,this.dateline=t.dateline||this.data.dateline,this.revocation=t.revocation||this.revocation,this.sessionVersion=t.sessionVersion||this.sessionVersion,this.firstShow=YYIMUtil.isWhateType(t.firstShow,"Boolean")?t.firstShow:!!this.firstShow,this.readed=YYIMUtil.isWhateType(t.readed,"Boolean")?t.readed:!!this.readed,this.received=YYIMUtil.isWhateType(t.received,"Boolean")?t.received:!!this.received,this.showInterval=YYIMUtil.isWhateType(t.showInterval,"Boolean")?t.showInterval:!!this.showInterval,this.received||this.sendState===E.SEND_STATE.READED||this.type!==E.CHAT_TYPE.CHAT||(this.sendState=t.sendState||this.sendState||E.SEND_STATE.NONE),this.from||(this.fromId=t.from||t.fromId),this.to||(this.toId=t.to||t.toId),this.init()},n.prototype.syncInfo=function(){this.data.dateline=this.dateline;var t,e,i;if(i=e=t=p.getInstance(),this.toId===YYIMChat.getUserID()&&(this.received=!0),this.type===E.CHAT_TYPE.PUB_ACCOUNT)this.received?t=c.getInstance():e=c.getInstance();else if(this.type===E.CHAT_TYPE.GROUP_CHAT){if(this.received?t=s.getInstance():e=s.getInstance(),this.fromId){this.fromRosterId=this.fromId.roster;var n=this.fromId.room;this.fromId=n,this.fromRosterId===YYIMChat.getUserID()&&(this.received=!1)}this.fromRoster&&this.fromRoster.id===YYIMChat.getUserID()&&(this.received=!1)}if(this.fromId){var o=this.type!=E.CHAT_TYPE.GROUP_CHAT?t.updateCache({id:this.fromId}):t.get(this.fromId);o&&(this.from=o,delete this.fromId)}if(this.toId){var a=this.type!=E.CHAT_TYPE.GROUP_CHAT?e.updateCache({id:this.toId}):e.get(this.toId);a&&(this.to=a,delete this.toId)}if(this.fromRosterId){var r=i.updateCache({id:this.fromRosterId});r&&(this.fromRoster=r,delete this.fromRosterId)}this.opposite=this.fromId||this.from.id;var h=this.toId||this.to.id;YYIMChat.getUserID()!==h&&(this.opposite=h),this.data.contentType==E.MESSAGE_CONTENT_TYPE.REVOCATION&&(this.revocation=this.fromRoster||this.from),this.getTemplateCode(),this.analysisAtmsg(),this.analysisExtend(),this.analysisLocation()},n.prototype.getTemplateCode=function(){!this.templateCode&&this.data&&(this.templateCode=this.data.contentType)},n.prototype.analysisLocation=function(){this.data.contentType==E.MESSAGE_CONTENT_TYPE.LOCATION&&(this.data.content.path="http://restapi.amap.com/v3/staticmap?location="+this.data.content.longitude+","+this.data.content.latitude+"&zoom=10&size="+E.LOCATION_SHOWPIC_SIZE+"&markers=mid,,A:"+this.data.content.longitude+","+this.data.content.latitude+"&key=ee95e52bf08006f63fd29bcfbcf21df0")},n.prototype.analysisExtend=function(){if(this.data&&this.data.extend&&!this.data.noticy)try{this.data.extend=JSON.parse(this.data.extend),this.data.extend.esndata&&(this.data.extend.esndata=JSON.parse(this.data.extend.esndata),this.data.extend.esndata.parent=this,this.data.noticy=new a(this.data.extend.esndata))}catch(t){this.data.extend=this.data.extend||{}}},n.prototype.analysisAtmsg=function(){this.type==E.CHAT_TYPE.GROUP_CHAT&&this.data&&this.data.contentType==E.MESSAGE_CONTENT_TYPE.TEXT&&"string"==typeof this.data.content&&this.data.atuser instanceof Array&&this.data.receipt&&this.data.atuser.indexOf(YYIMChat.getUserID())>-1&&(this.data.isHaveAt=!0)},n.prototype.getConvertedIds=function(t){var e=this;this.data.contentType==E.MESSAGE_CONTENT_TYPE.FILE&&YYIMChat.getTransformFileList({attachId:this.data.content.attachId,success:function(t){t.result&&(e.data.convertedIds=t.result)}})},o.prototype=new t,o.getInstance=function(){return this._instance||(this._instance=new o),this._instance},o.prototype.updateCache=function(t){if(t){var e=t.msgId||t.packetId||t.id;if(e){var s=this.get(e),i=!1;if(s)s.build(t);else{if(s=new n(t),!s.data)return;this.set(e,s),i=!0}s.data.contentType==E.MESSAGE_CONTENT_TYPE.FILE&&(this.attachMapped[s.data.content.attchId]=s);try{var o=s.fromId||s.from.id,a=s.toId||s.to.id}catch(r){return}if(YYIMChat.getUserID()!==a&&(o=a),o){this.messList[o]||(this.messList[o]={},this.messList[o].readed=[],this.messList[o].unreaded=[],this.messList[o].all=[]),i&&this.messList[o].all.push(s),this.messList[o].readed.length=0,this.messList[o].unreaded.length=0;for(var c in this.messList[o].all){var h=this.messList[o].all[c];h&&h.readed===!0?this.messList[o].readed.push(h):h&&h.readed===!1&&this.messList[o].unreaded.push(h)}this.messList[o].readed=this.messList[o].readed.sort(YYIMUtil.array.comparisonAsc("dateline")),this.messList[o].unreaded=this.messList[o].unreaded.sort(YYIMUtil.array.comparisonAsc("dateline")),this.messList[o].all=this.messList[o].all.sort(YYIMUtil.array.comparisonAsc("dateline"))}return this.getShowInterval(s),(t.sendState==E.SEND_STATE.READED||s.received)&&this.receiveReceipts(s.id),s}}},o.prototype.getShowInterval=function(t){if(t&&t.opposite){var e=t.dateline,s=t.opposite;this.showInterval[s]=this.showInterval[s]||{max:e,min:e},e-this.showInterval[s].max>E.PRE_SHOW_TIMEINTERVAL?(this.showInterval[s].max=e,t.build({showInterval:!0})):this.showInterval[s].min-e>E.PRE_SHOW_TIMEINTERVAL?(this.showInterval[s].min=e,t.build({showInterval:!0})):this.showInterval[s].min==this.showInterval[s].max&&this.showInterval[s].min==e?t.build({showInterval:!0}):t.firstShow===!0&&(this.firstShow&&this.firstShow.build({showInterval:!1}),this.firstShow=t,this.firstShow.build({showInterval:!0}))}},o.prototype.getHistoryMessage=function(t){var e=t.id||t.to;if(e){var s=m.getInstance().get(e);if(s){var i=this;if(i.history=i.history||{},i.history[e]=i.history[e]||{},i.history[e].start=i.history[e].start||0,i.history[e].present=t.present||i.history[e].present||0,i.history[e].isEnd)return void(t.success&&t.success({count:0,isEnd:!0}));this.TemphisMsgList=this.TemphisMsgList||[],YYIMChat.getHistoryMessage({id:e,chatType:t.chatType||t.type||E.CHAT_TYPE.CHAT,contentType:t.contentType,start:i.history[e].start||0,size:E.PRE_HISTORY_LENGTH,endVersion:s.originVersion,success:function(s){var n=s.result.length<=E.PRE_HISTORY_LENGTH-i.history[e].present&&s.result.length<E.PRE_HISTORY_LENGTH,o=!1,a=null;s.result.sort(YYIMUtil.array.comparisonDesc("dateline"));try{var r=s.result[s.result.length-1];r&&(r.firstShow=!0)}catch(c){}for(var h in s.result){var d=s.result[h],p=d.msgId||d.packetId||d.id,u=i.get(p);if(u||(d.readed=!0,a=i.updateCache(d),i.history[e].present+=1),i.history[e].start+=1,a){var l=i.messList[e].all,f=0;if(l&&l.length&&(f=l[l.length-1].dateline),a.dateline>=f)if(a.data.contentType==E.MESSAGE_CONTENT_TYPE.REVOCATION){var T=a.fromRoster||a.from,I=T.name+"撤回了一条消息";T.id==YYIMChat.getUserID()&&(I="您撤回了一条消息"),m.getInstance().updateCache({id:e,dateline:a.dateline,latestState:I,contentType:a.data.contentType,sessionVersion:a.sessionVersion,type:a.type,sort:!1})}else m.getInstance().updateCache({id:e,dateline:a.dateline,latestState:a.data,contentType:a.data.contentType,sessionVersion:a.sessionVersion,type:a.type,sort:!1});i.TemphisMsgList.push(a)}if(i.history[e].present>=E.PRE_HISTORY_LENGTH){o=!0;break}}if(n||o){var y=i.history[e].present;i.history[e].present=0,n&&(i.history[e].isEnd=!0),t.success&&t.success({list:i.TemphisMsgList,count:y,isEnd:n,isFull:o}),i.TemphisMsgList.length=0}else i.getHistoryMessage(t)},error:function(){t.error&&t.error()},complete:function(){t.complete&&t.complete()}})}}},o.prototype.getOfflineMessage=function(t){YYIMChat.getOfflineMessage(t)},o.prototype.getMessageList=function(t){try{return this.messList[t.id][t.condition||"all"]}catch(e){return[]}},o.prototype.getLastValidMessage=function(t){for(var e=this.getMessageList(t),s=e.length;s--;)if(!e[s].revocation)return e[s]},o.prototype.showMessageList=function(t){try{var e=t.id;for(var s in this.messList[e].unreaded){var i=this.messList[e].unreaded[s];i&&i.id&&this.updateCache({id:i.id,readed:!0})}var n=this.messList[e].all,o=n[n.length-1];if(o){var a=m.getInstance().get(e);a&&a.sessionVersion-a.readedVersion&&(m.getInstance().updateCache({id:e,type:a.type,readedVersion:a.sessionVersion}),this.sendReceipts(o.id))}return n}catch(r){return[]}},o.prototype.receiveReceipts=function(t){if(t){var e=this.get(t);if(e)for(var s in this.messList[e.opposite].all){var i=this.messList[e.opposite].all[s];i&&i.sessionVersion<=e.sessionVersion&&i.build({sendState:E.SEND_STATE.READED})}}},o.prototype.sendReceipts=function(t){if(t){var e=this.get(t);if(e&&e.data.receipt&&e.data.receipt){var s=m.getInstance().get(e.opposite);s&&e.data.receipt.sessionVersion<s.sessionVersion&&(e.data.receipt.sessionVersion=s.sessionVersion),YYIMChat.sendReadedReceiptsPacket(e.data.receipt)}}},o.prototype.revocationMessage=function(t){t=t||{};var e=this.get(t.id);e&&!e.revocation&&YYIMChat.revocationMessage(t)},o.prototype.sendTextMessage=function(t){var e,s=t.type||E.CHAT_TYPE.CHAT,i=t.to||t.id,n=this;if(this.atUserList.length){e=[];for(var o in this.atUserList)e.push(this.atUserList[o].id)}var a={to:i,type:s,msg:t.msg,atuser:e,style:t.style,extend:JSON.stringify(this.atUserList),success:function(e){e.type=s,e.readed=!0,e.sendState=E.SEND_STATE.UNREADED;var i=n.updateCache(e);t.success&&t.success(i)}};this.atUserList.length=0,YYIMChat.sendTextMessage(a)},o.prototype.sendShareMessage=function(t){var e=this,s=t.type||E.CHAT_TYPE.CHAT;t.to||t.id;YYIMChat.sendShareMessage({to:t.to||t.id,type:s,sharebody:t.sharebody,extend:t.extend,success:function(i){i.type=s,i.readed=!0,i.sendState=E.SEND_STATE.UNREADED;var n=e.updateCache(i);t.success&&t.success(n)}})},o.prototype.sendPicMessage=function(t){var e=this;YYIMChat.sendPic({fileInputId:t.fileInputId,fileFiltered:t.fileFiltered,beforeUpload:t.beforeUpload,chatInfo:t.chatInfo,success:function(s){s.readed=!0,s.sendState=E.SEND_STATE.UNREADED;var i=e.updateCache(s);t.success&&t.success(i)},progress:function(e){YYIMChat.log("uploadProgress",3,e.percent),t.progress&&t.progress(e)}})},o.prototype.sendFileMessage=function(t){var e=this;YYIMChat.sendFile({fileInputId:t.fileInputId,fileFiltered:t.fileFiltered,beforeUpload:t.beforeUpload,chatInfo:t.chatInfo,success:function(s){s.readed=!0,s.sendState=E.SEND_STATE.UNREADED;var i=e.updateCache(s);t.success&&t.success(i)},progress:function(e){YYIMChat.log("uploadProgress",3,e.percent),t.progress&&t.progress(e)}})},o.prototype.sendFormMessage=function(t){var e=this,s=t.type||E.CHAT_TYPE.CHAT,i=t.to||t.id;YYIMChat.sendFormMessage({file:{name:t.file.name,size:t.file.size},mediaType:t.mediaType||1,data:t.data,to:i,type:s,success:function(i){i.type=s,i.readed=!0,i.sendState=E.SEND_STATE.UNREADED;var n=e.updateCache(i);t.success&&t.success(n)},progress:function(e){console.log("progress"),console.log(e),t.progress&&t.progress(e)}})},o.prototype.PostMessage=function(t){var e=this,s=t.type||E.CHAT_TYPE.CHAT;t.to||t.id;YYIMChat.postMessage({content:t.content,to:t.to,contentType:t.contentType,type:t.type,success:function(i){i.type=s,i.readed=!0,i.sendState=E.SEND_STATE.UNREADED;var n=e.updateCache(i);t.success&&t.success(n)},progress:function(t){console.log("progress"),console.log(t)}})},o.prototype.forwardMessage=function(t){var e=this,s=e.get(t.mid);if(s){switch(s.data.contentType){case E.MESSAGE_CONTENT_TYPE.TEXT:var i={to:t.to,msg:s.data.content,type:s.type,success:function(t){m.getInstance().updateCache({id:t.opposite,dateline:t.dateline,latestState:t.data,contentType:t.data.contentType,type:t.type,sort:!0})}};e.sendTextMessage(i);break;case E.MESSAGE_CONTENT_TYPE.FILE:var i={to:t.to,content:s.data.content,contentType:s.data.contentType,type:s.type,success:function(t){m.getInstance().updateCache({id:t.opposite,dateline:t.dateline,latestState:t.data,contentType:t.data.contentType,type:t.type,sort:!0})}};e.PostMessage(i);break;case E.MESSAGE_CONTENT_TYPE.IMAGE:var i={to:t.to,content:s.data.content,contentType:s.data.contentType,type:s.type,success:function(t){m.getInstance().updateCache({id:t.opposite,dateline:t.dateline,latestState:t.data,contentType:t.data.contentType,type:t.type,sort:!0})}};e.PostMessage(i);break;case E.MESSAGE_CONTENT_TYPE.AUDO:}t.success&&t.success()}},o.prototype.sendWhiteBoardMessage=function(t){var e=this,s=t.type||E.CHAT_TYPE.CHAT,i=t.to||t.id;YYIMChat.sendWhiteBoardMessage({to:i,type:s,extend:t.extend,content:t.content,success:function(i){i.type=s,i.readed=!0,i.sendState=E.SEND_STATE.UNREADED;var n=e.updateCache(i);t.success&&t.success(n)}})},o.prototype.updateCacheByTransMessage=function(t){switch(t.category){case E.TRAMSPARENT_TYPE.ATTACHMENTCONVERTED:try{var e=JSON.parse(t.attributes.convertedInfo),s=this.attachMapped[e.attachId];return s&&(s.data.convertedIds=e.result),s}catch(i){}break;case E.TRAMSPARENT_TYPE.REVOKE:if(t&&t.attributes&&t.attributes.packetId){var s=this.get(t.attributes.packetId);if(s)return s.build({revocation:p.getInstance().updateCache({id:t.from.roster||t.from})}),s}break;case E.TRAMSPARENT_TYPE.SETMUTE:var n=this.getEntity(t.attributes.bareJID);if(n){n.build({mute:!0});var o=m.getInstance().get(n.id);if(o)return o.build({}),o}break;case E.TRAMSPARENT_TYPE.CANCELMUTE:var n=this.getEntity(t.attributes.bareJID);if(n){n.build({mute:!1});var o=m.getInstance().get(n.id);if(o)return o.build({}),o}break;case E.TRAMSPARENT_TYPE.SETSTICK:var n=this.getEntity(t.attributes.bareJID);if(n){n.build({stick:!0});var o=m.getInstance().get(n.id);if(o)return m.getInstance().updateCache({id:n.id,type:o.type,stick:!0}),o}break;case E.TRAMSPARENT_TYPE.CANCELSTICK:var n=this.getEntity(t.attributes.bareJID);if(n){n.build({stick:!1});var o=m.getInstance().get(n.id);if(o)return m.getInstance().updateCache({id:n.id,type:o.type,stick:!1}),o}}},o.prototype.getEntity=function(t){t=t||{};var e=t.to||t.id;if(t&&e&&t.type)switch(t.type){case E.CHAT_TYPE.GROUP_CHAT:return s.getInstance().get(e);case E.CHAT_TYPE.PUB_ACCOUNT:return c.getInstance().updateCache({id:e});default:return p.getInstance().updateCache({id:e})}},o.prototype.destory=function(){this.messList={},this.showInterval={},this.atUserList.length=0,this.attachMapped={},this.history={},this.clear()},a.prototype.build=function(t){this.id=t.noticeId||this.noticeId,this.title=t.title||this.title,this.type_detail=t.type_detail||this.type_detail,this.detail_url=t.detail_url||this.detail_url,this.type=t.type||this.type,this.highlight=t.highlight||this.highlight,this.authorid=t.authorid||this.authorid,this.avatar=t.avatar||this.avatar,this.content=t.content||this.content,this.created=t.created||this.created,this.spaceId=t.qz_id||this.spaceId,this.from_id=t.from_id||this.from_id,this.noticeId=t.noticeId||this.noticeId,this.srcData=t.srcData||this.srcData,this.note=t.note||this.note,this.pending=YYIMUtil.isWhateType(t.pending,"Number")?t.pending:this.pending||0,this.parent=t.parent||this.parent,this.businessId=this.type_detail+"_"+this.from_id,this.syncInfo(t)},a.prototype.syncInfo=function(t){this.parent&&this.parent.from&&this.parent.from.noticyType&&(this.noticyType=this.parent.from.noticyType),this.authorid&&"0"!==this.authorid&&!this.author&&(this.author=p.getInstance().updateCache({id:this.authorid}))};var C=function(){function t(t){t=t||{},YYIMChat.getProfile({success:function(s){if(s&&s.muteItems)for(var i in s.muteItems)if(s.muteItems[i].id){var n=e(s.muteItems[i]);if(n){n.build({mute:!0});var o=m.getInstance().get(n.id);o&&o.build({})}}if(s&&s.stickItems)for(var i in s.stickItems)if(s.stickItems[i].id){var n=e(s.stickItems[i]);if(n){n.build({stick:!0});var o=m.getInstance().get(n.id);o&&m.getInstance().updateCache({id:n.id,type:o.type,stick:!0})}}t.success&&t.success(s)},error:t.error})}function e(t){t=t||{};var e=t.to||t.id;if(t&&e&&t.type)switch(t.type){case E.CHAT_TYPE.GROUP_CHAT:return s.getInstance().updateCache({id:e});case E.CHAT_TYPE.PUB_ACCOUNT:return c.getInstance().updateCache({id:e});default:return p.getInstance().updateCache({id:e})}}function i(t){t=t||{};var s=e(t);s&&YYIMChat.mute({to:t.to,type:t.type,success:function(e){s.build({mute:!0});var i=m.getInstance().get(s.id);i&&i.build({}),t.success&&t.success(e)},error:t.error})}function n(t){t=t||{};var s=e(t);s&&YYIMChat.cancelMute({to:t.to,type:t.type,success:function(e){s.build({mute:!1});var i=m.getInstance().get(s.id);i&&i.build({}),t.success&&t.success(e)},error:t.error})}function o(t){t=t||{};var s=e(t);s&&YYIMChat.stick({to:t.to,type:t.type,success:function(e){s.build({stick:!0});var i=m.getInstance().get(s.id);i&&m.getInstance().updateCache({id:s.id,type:i.type,stick:!0}),t.success&&t.success(e)},error:t.error})}function a(t){t=t||{};var s=e(t);s&&YYIMChat.cancelStick({to:t.to,type:t.type,success:function(e){s.build({stick:!1});var i=m.getInstance().get(s.id);i&&m.getInstance().updateCache({id:s.id,type:i.type,stick:!1}),t.success&&t.success(e)},error:t.error})}function r(t){YYIMChat.createProfile(t)}function h(t){YYIMChat.removeProfile(t)}function d(t){t=t||{},YYIMChat.clearProfile({success:function(){s.getInstance().forEach(function(t,e,s){e.build({mute:!1,stick:!1});var i=m.getInstance().get(e.id);i&&m.getInstance().updateCache({id:e.id,type:i.type,stick:!1})}),c.getInstance().forEach(function(t,e,s){e.build({mute:!1,stick:!1});var i=m.getInstance().get(e.id);i&&m.getInstance().updateCache({id:e.id,type:i.type,stick:!1})}),p.getInstance().forEach(function(t,e,s){e.build({mute:!1,stick:!1});var i=m.getInstance().get(e.id);i&&m.getInstance().updateCache({id:e.id,type:i.type,stick:!1})}),t.success&&t.success()},error:t.error})}return{getProfile:t,mute:i,cancelMute:n,stick:o,cancelStick:a,createProfile:r,removeProfile:h,clearProfile:d}}();r.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name||this.id,this.type=t.type||this.type||E.PUBACCOUNT_TYPE.BROADCASE.TYPE,this.photo=t.photo||this.photo,this.group=t.group||this.group,this.tag=t.tag||this.tag,this.mute=YYIMUtil.isWhateType(t.mute,"Boolean")?t.mute:!!this.mute,this.stick=YYIMUtil.isWhateType(t.stick,"Boolean")?t.stick:!!this.stick,this.loadedInfo=YYIMUtil.isWhateType(t.loadedInfo,"Boolean")?t.loadedInfo:!!this.loadedInfo,this.syncInfo()},r.prototype.syncInfo=function(){this.getAttributes(),this.initInfo()},r.prototype.initInfo=function(){if(!this.loadedInfo){if(this.querying)return;this.querying=!0;var t=this;YYIMChat.getPubAccountInfo({id:this.id,success:function(e){t.build(e);var s=m.getInstance().get(e.id);s&&(m.getInstance().remove(s.id),m.getInstance().updateCache(s)),t.getPubaccountType(),t.loadedInfo=!0,t.querying=!1},error:function(e){var s=m.getInstance().get(t.id);s&&m.getInstance().remove(s.id)}})}},r.prototype.getAttributes=function(){if(this.id&&!this.spaceId){var t=this.id.split("_");if(t.length>1&&!this.pubType)for(var e in g.PUBACCOUNTTYPE)if(g.PUBACCOUNTTYPE[e].name==t[0]){this.pubType=t[0],this.spaceId=t[1],this.pubType==g.PUBACCOUNTTYPE.APPACCOUNT.name&&t[2]&&(this.appId=t[2]),this.pubType==g.PUBACCOUNTTYPE.PUBACCOUNT.name&&t[2]&&(this.noticyType=t[2],g.PUBACCOUNTTYPE.PUBACCOUNT.type[this.noticyType]&&(this.photo=this.photo||g.PUBACCOUNTTYPE.PUBACCOUNT.type[this.noticyType].photo));break}}this.photo=this.photo||E.DEFAULT_PHOTO.PUBACCOUNT},r.prototype.getPhotoUrl=function(){return this.photo},r.prototype.getPubaccountType=function(){if(!this.pubaccountType)switch(this.type){case E.PUBACCOUNT_TYPE.BROADCASE.TYPE:this.pubaccountType=E.PUBACCOUNT_TYPE.BROADCASE.NAME;break;case E.PUBACCOUNT_TYPE.SUBSCRIBED.TYPE:case E.PUBACCOUNT_TYPE.SUBSCRIBE.TYPE:this.pubaccountType=E.PUBACCOUNT_TYPE.SUBSCRIBE.NAME}return this.pubaccountType},c.prototype=new t,c.getInstance=function(t){return this._instance||(this._instance=new c),this._instance.spaceId=t,this._instance},c.prototype.updateCache=function(t){if(t&&t.id){var e=this.get(t.id);return e?e.build(t):(e=new r(t),this.set(e.id,e)),e}},c.prototype.queryPubaccount=function(t){YYIMChat.queryPubaccount(t)},c.prototype.addPubaccount=function(t){if(t&&t.id){var e=this.get(t.id);e||YYIMChat.addPubaccount(t)}},c.prototype.removePubaccount=function(t){if(t&&t.id){var e=this.get(t.id);if(e){var s=this;YYIMChat.removePubaccount({id:t.id,success:function(e){s.remove(e.from),t.success&&t.success(e)},error:function(){t.error&&t.error()},complete:function(){t.complete&&t.complete()}})}}},c.prototype.getPubaccountList=function(t){var e=[];for(var s in this.list)if(!this.list[s].spaceId||this.list[s].spaceId==this.spaceId){if("undefined"==typeof t){e.push(this.list[s]);continue}this.list[s].pubaccountType===t&&e.push(this.list[s])}return e},c.prototype.destory=function(){this.clear()},h.prototype.build=function(t){if(t.show&&t.resource)for(var e in E.TERMINAL_TYPE)if(t.resource.toLowerCase().indexOf(E.TERMINAL_TYPE[e])!==-1){this.presence[E.TERMINAL_TYPE[e]]={show:t.show,resource:t.resource};break}},d.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||t.nickname||this.name,this.ask=t.ask||this.ask,this.recv=t.recv||this.recv,this.resource=t.resource||this.resource,this.subscription=t.subscription||this.subscription,this.group=t.group||this.group,this.photo=t.photo||this.photo,this.vcard=t.vcard||this.vcard,this.loadedInfo=YYIMUtil.isWhateType(t.loadedInfo,"Boolean")?t.loadedInfo:!!this.loadedInfo,this.tag=t.tag||this.tag,this.mute=YYIMUtil.isWhateType(t.mute,"Boolean")?t.mute:!!this.mute,this.stick=YYIMUtil.isWhateType(t.stick,"Boolean")?t.stick:!!this.stick,
this.init()},d.prototype.init=function(){this.id=this.id.toString(),this.getRosterType(),this.syncInfo(),this.initVCard(),this.updatePresence()},d.prototype.updatePresence=function(t){t=t||{},t.id=this.id,t.resource=t.resource||this.resource,t.show=t.show||E.PRESENCE_SHOW.UNAVAILABLE,this.presence?this.presence.build(t):this.presence=new h(t)},d.prototype.getPresence=function(t){var e=this.presence.presence[t||E.TERMINAL_TYPE.WEB];if(e)return e.show},d.prototype.setVCard=function(t){if(this.rosterType===E.ROSTER_TYPE.MYSELF&&t.vcard){var e=this;YYIMChat.setVCard({vcard:t.vcard,success:function(){e.vcard.build(t.vcard),e.syncInfo(),t.success&&t.success()},error:function(){t.error&&t.error()}})}},d.prototype.setRemark=function(t){if(this.rosterType===E.ROSTER_TYPE.FRIEND&&t&&t.roster&&(t.roster.name!==this.name||t.roster.group!==this.group)){var e=this;YYIMChat.updateRosterItem({roster:{id:this.id,name:t.roster.name,groups:t.roster.group},suceess:function(){e.build({name:t.roster.name,group:t.roster.group}),t.success&&t.success()},error:function(){t.error&&t.error()}})}},d.prototype.initVCard=function(){var t=this;if(!this.loadedInfo){if(this.querying)return;this.querying=!0,this.vcard=new u({id:this.id,name:this.name||this.id,photo:this.photo}),YYIMChat.getVCard({id:this.id,success:function(e){e.enableFields&&p.getInstance().build({enableVCardFields:e.enableFields}),t.vcard.build(e),t.build({tag:e.tag}),t.syncInfo(),t.loadedInfo=!0,t.querying=!1}})}},d.prototype.syncInfo=function(){this.name&&this.name!=this.id&&this.rosterType!==E.ROSTER_TYPE.MYSELF||!this.vcard||!this.vcard.name||(this.name=this.vcard.name),this.vcard&&this.vcard.photo&&(this.photo=this.vcard.photo,this.avatar=this.photo)},d.prototype.getPhotoUrl=function(){return this.photo},d.prototype.getRosterType=function(){return this.id===YYIMChat.getUserID()?this.rosterType=E.ROSTER_TYPE.MYSELF:this.subscription===E.ROSTER_SUBSCRIPTION_TYPE.BOTH?this.rosterType=E.ROSTER_TYPE.FRIEND:this.subscription===E.ROSTER_SUBSCRIPTION_TYPE.NONE&&1===this.ask?this.rosterType=E.ROSTER_TYPE.ASK:this.subscription===E.ROSTER_SUBSCRIPTION_TYPE.NONE&&1===this.recv?this.rosterType=E.ROSTER_TYPE.RECV:this.rosterType=E.ROSTER_TYPE.NONE,this.rosterType},p.prototype=new t,p.getInstance=function(){return this._instance||(this._instance=new p),this._instance},p.prototype.build=function(t){this.enableVCardFields=YYIMUtil.isWhateType(t.enableVCardFields,"Array")?t.enableVCardFields:this.enableVCardFields||[]},p.prototype.init=function(){this.updateCache({id:YYIMChat.getUserID()}),this.build({}),this.getRostersPresence()},p.prototype.updateCache=function(t){if(t&&t.id){var e=this.get(t.id);return e?e.build(t):(e=new d(t),this.set(e.id,e)),e}},p.prototype.addRoster=function(t){if(t){var e=this.get(t);e&&this.getRostersList("none").indexOf(e)===-1||(YYIMChat.addRosterItem(t),this.updateCache({id:t,ask:1,recv:-1,subscription:E.ROSTER_SUBSCRIPTION_TYPE.NONE}))}},p.prototype.deleteRoster=function(t){if(t&&this.getRostersList("friend").indexOf(this.get(t.id))!==-1){var e=this;YYIMChat.deleteRosterItem({id:t.id,success:function(){e.updateCache({id:t.id,ask:-1,recv:-1,subscription:E.ROSTER_SUBSCRIPTION_TYPE.NONE}),t.success&&t.success()},complete:function(){t.complete&&t.complete()}})}},p.prototype.approveRoster=function(t){t&&this.getRostersList("recv").indexOf(this.get(t))!==-1&&(YYIMChat.approveSubscribe(t),this.updateCache({id:t,ask:-1,recv:-1,subscription:E.ROSTER_SUBSCRIPTION_TYPE.BOTH}))},p.prototype.removeRoster=function(t){this.remove(t)},p.prototype.updatePresence=function(t){if(t&&(t.from||t.id)){var e=this.get(t.from||t.id);e&&e.updatePresence(t)}},p.prototype.getRostersPresence=function(){var t=this;setTimeout(function(){var e=[];for(var s in this.list)this.get(s).id&&e.push(this.get(s).id);e.length&&YYIMChat.getRostersPresence({username:e,success:function(e){for(var s in e){var i=e[s].presence;for(var n in i)i[n].available&&t.updatePresence({id:e[s].userid,resource:i[n].device,show:i[n].show})}}})},500)},p.prototype.setVCard=function(t){var e=this.get(YYIMChat.getUserID());e&&e.setVCard(t)},p.prototype.setRemark=function(t){if(t&&t.roster&&t.roster.id){var e=this.get(t.roster.id);e&&e.setRemark(t)}},p.prototype.getRostersList=function(t){var e=this.get(),s=[];for(var i in e)"undefined"!=typeof t?e[i].rosterType===t&&s.push(e[i]):s.push(e[i]);return s},p.prototype.destory=function(){this.enableVCardFields.length=0,this.clear()},u.prototype.build=function(t){this.id=t.id||t.userId||t.member_id||this.id,this.name=t.name||t.nickname||this.name,this.email=t.email||this.email,this.photo=t.photo||this.photo,this.sysInfo()},u.prototype.sysInfo=function(t){this.photo||(this.photo=E.DEFAULT_PHOTO.ROSTER),this.photo.indexOf("http://")==-1&&this.photo.indexOf("https://")==-1&&(this.photo=y.STATICADDRESS+this.photo),this.avatar=this.photo},l.prototype=new t,l.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name||this.id,this.updateCache(t.entity),this.syncInfo()},l.prototype.getSpaceAttributes=function(){var t=this.getRecentList();this.notice=0,this.dateline=0;for(var e in t)t[e].notice&&(this.notice+=t[e].notice),t[e].dateline>this.dateline&&(this.dateline=t[e].dateline)},l.prototype.syncInfo=function(){this.getSpaceAttributes()},l.prototype.updateCache=function(t){if(t&&t.id){var e,i,n;switch(t.type){case E.CHAT_TYPE.GROUP_CHAT:i=s.getInstance().updateCache({id:t.id}),!i.loadedInfo&&t&&t.from&&(i=s.getInstance().updateCache({id:t.id,name:t.from.name}));break;case E.CHAT_TYPE.PUB_ACCOUNT:i=c.getInstance().updateCache({id:t.id}),!i.loadedInfo&&t&&t.from&&(i=c.getInstance().updateCache({id:t.id,name:t.from.name,group:t.from.group}));break;default:i=p.getInstance().updateCache({id:t.id}),!i.loadedInfo&&t&&t.from&&(i=p.getInstance().updateCache({id:t.id,name:t.from.name}))}if(!i)return;var n=this.get(t.id);if(n&&YYIMUtil.isWhateType(t.stick,"Boolean")&&t.stick!==n.stick&&t.stick===i.stick&&(n.stick=t.stick,t=n,this.remove(t.id),n=null),n){n.build(t);var o=this.recentNormalList;n.stick&&(o=this.recentTopList),t.sort&&o.indexOf(n)>-1&&0!=o.indexOf(n)&&(o.splice(o.indexOf(n),1),o.unshift(n))}else{t.parent=this,n=new f(t);var e;if(e=n.type===E.CHAT_TYPE.GROUP_CHAT?s.getInstance():n.type===E.CHAT_TYPE.PUB_ACCOUNT?c.getInstance():p.getInstance(),!e.get(n.id))return;this.set(n.id,n);var o=this.recentNormalList;n.stick&&(o=this.recentTopList),o.unshift(n)}return this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList),n.from.spaceId&&this.spaceIds.indexOf(n.from.spaceId)==-1&&this.spaceIds.push(n.from.spaceId),n}},l.prototype.remove=function(t){if(t){var e=this.get(t);e&&(delete this.list[t],this.recentTopList.indexOf(e)>-1&&this.recentTopList.splice(this.recentTopList.indexOf(e),1),this.recentNormalList.indexOf(e)>-1&&this.recentNormalList.splice(this.recentNormalList.indexOf(e),1),this.recentList=this.recentTopList.concat(this.recentNormalList))}},l.prototype.getAllRecentList=function(){return this.list},l.prototype.getRecentList=function(){this.recentList=this.recentTopList.concat(this.recentNormalList);var t=[];for(var e in this.recentList)this.recentList[e].type!=E.CHAT_TYPE.CHAT&&this.recentList[e].spaceId&&this.recentList[e].spaceId!=currentSpaceId||t.push(this.recentList[e]);return t},l.prototype.queryRecentList=function(t){this.recentList=this.recentTopList.concat(this.recentNormalList);var e=[];for(var s in this.recentList)if(this.recentList[s].type==E.CHAT_TYPE.CHAT||!this.recentList[s].spaceId||this.recentList[s].spaceId==currentSpaceId){var i=this.recentList[s].from;(i.name&&i.name.indexOf(t)>-1||i.vcard&&i.vcard.mobile&&i.vcard.mobile.indexOf(t)>-1)&&e.push(this.recentList[s])}return e},l.prototype.getListByChatType=function(t){this.recentList=this.recentTopList.concat(this.recentNormalList);var e=[];for(var s in this.recentList)t&&this.recentList[s].type!=t||this.recentList[s].spaceId&&this.recentList[s].spaceId!=currentSpaceId||e.push(this.recentList[s]);return e},l.prototype.getPhotoUrl=function(){return E.DEFAULT_PHOTO.PUBACCOUNTFOLDED},f.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name||this.id,this.dateline=t.dateline||t.lastContactTime||this.dateline,this.type=t.type||this.type,this.latestState=t.latestState||this.latestState,this.lastMessage=t.lastMessage||this.lastMessage,this.contentType=t.contentType||this.contentType,this.readedVersion=this.readedVersion||0,this.sessionVersion=this.sessionVersion||0,this.parent=t.parent||this.parent,this.isHaveAt=YYIMUtil.isWhateType(t.isHaveAt,"Boolean")?t.isHaveAt:!!this.isHaveAt,this.syncInfo(t)},f.prototype.syncInfo=function(t){if(this.readedVersion=t.readedVersion>=this.readedVersion?Number(t.readedVersion):this.readedVersion,this.sessionVersion=t.sessionVersion>=this.sessionVersion?Number(t.sessionVersion):this.sessionVersion,this.readedVersion=this.readedVersion>this.sessionVersion?this.sessionVersion:this.readedVersion,void 0==this.originVersion&&(this.originVersion=this.sessionVersion),!this.from)switch(this.type){case E.CHAT_TYPE.CHAT:this.from=p.getInstance().updateCache({id:this.id}),!this.from.loadedInfo&&t&&t.from&&(this.from=p.getInstance().updateCache({id:this.id,name:t.from.name}));break;case E.CHAT_TYPE.GROUP_CHAT:this.from=s.getInstance().updateCache({id:this.id}),!this.from.loadedInfo&&t&&t.from&&(this.from=s.getInstance().updateCache({id:this.id,name:t.from.name}));break;case E.CHAT_TYPE.PUB_ACCOUNT:this.from=c.getInstance().updateCache({id:this.id}),!this.from.loadedInfo&&t&&t.from&&(this.from=c.getInstance().updateCache({id:this.id,name:t.from.name,group:t.from.group}))}if(this.from&&(this.mute=this.from.mute,this.stick=this.from.stick,this.spaceId=this.from.spaceId),this.from&&this.from.name!==this.from.id&&(this.name=this.from.name),this.lastMessage){if(this.latestState=this.lastMessage.data,this.lastMessage.data&&(this.dateline=this.lastMessage.data.dateline||this.dateline),this.lastMessage&&this.lastMessage.data.contentType==E.MESSAGE_CONTENT_TYPE.REVOCATION){var e=o.getInstance().updateCache(this.lastMessage),i=e.fromRoster||e.from;return this.latestState=i.name+"撤回了一条消息",i.id==YYIMChat.getUserID()&&(this.latestState="您撤回了一条消息"),this.showState=this.latestState,void(this.lastMessage=null)}this.lastMessage=null}if(this.notice=Math.abs(this.sessionVersion-this.readedVersion),this.latestState)switch("string"!=typeof this.latestState&&(this.contentType=this.contentType||this.latestState.contentType),this.contentType){case E.MESSAGE_CONTENT_TYPE.FILE:this.showState="[文件]";break;case E.MESSAGE_CONTENT_TYPE.IMAGE:this.showState="[图片]";break;case E.MESSAGE_CONTENT_TYPE.SYSTEM:try{"string"!=typeof this.latestState?this.showState=this.latestState.content.title:this.showState=this.latestState}catch(n){this.showState="[单图文]"}break;case E.MESSAGE_CONTENT_TYPE.PUBLIC:try{"string"!=typeof this.latestState?this.showState=this.latestState.content[0].title:this.showState=this.latestState}catch(n){this.showState="[多图文]"}break;case E.MESSAGE_CONTENT_TYPE.SMALLVIDEO:this.showState="[小视频]";break;case E.MESSAGE_CONTENT_TYPE.AUDO:this.showState="[音频]";break;case E.MESSAGE_CONTENT_TYPE.LOCATION:this.showState="[位置]";break;case E.MESSAGE_CONTENT_TYPE.SHARE:this.showState="[分享]";break;case E.MESSAGE_CONTENT_TYPE.WHITEBOARD:this.showState="[白板]";break;default:if(this.latestState){if(this.showState=null,"string"!=typeof this.latestState){this.latestState.atContent&&(this.showState=this.latestState.atContent),this.latestState=this.latestState.content,this.showState=this.showState||this.latestState;break}this.showState=this.latestState}}},m.prototype=new t,m.getInstance=function(t){return this._instance||(this._instance=new m),this._instance.spaceId=t,this._instance},m.prototype.init=function(){var t=this;jQuery(window).on("unload",function(){t.save()})},m.prototype.getRecentDigset=function(t){t=t||{};var e=this,i=Y.localstorage.getItem("IMCHATVERSION_"+YYIMChat.getUserNode())||"";E.IMCHATVERSION&&i!=E.IMCHATVERSION&&(Y.localstorage.removeItem("GROUPTIMESTAMP_"+YYIMChat.getUserNode()),Y.localstorage.removeItem("RECENTTIMESTAMP_"+YYIMChat.getUserNode()),Y.localstorage.removeItem("RECENTDATA_"+YYIMChat.getUserNode()),Y.localstorage.removeItem("GROUPDATA_"+YYIMChat.getUserNode()),Y.localstorage.setItem("IMCHATVERSION_"+YYIMChat.getUserNode(),E.IMCHATVERSION));var n=Y.localstorage.getItem("RECENTDATA_"+YYIMChat.getUserNode())||"",o=[],a={};try{n=JSON.parse(n);for(x in n)n[x].type==E.CHAT_TYPE.PUB_ACCOUNT&&o.indexOf(n[x].id)==-1&&(o.push(n[x].id),a[n[x].id]=n[x]),e.updateCache(n[x])}catch(r){Y.localstorage.setItem("RECENTTIMESTAMP_"+YYIMChat.getUserNode(),0)}s.getInstance().initLocal({success:function(){YYIMChat.getRecentDigset({startDate:Number(Y.localstorage.getItem("RECENTTIMESTAMP_"+YYIMChat.getUserNode()))||0,success:function(s){Y.localstorage.setItem("RECENTTIMESTAMP_"+YYIMChat.getUserNode(),s.ts);for(var i in s.list)s.list[i].type==E.CHAT_TYPE.PUB_ACCOUNT&&o.indexOf(s.list[i].id)==-1&&(o.push(s.list[i].id),a[s.list[i].id]=s.list[i]),e.updateCache(s.list[i]);o.length?YYIMChat.getPubAccounts({pubIds:o,success:function(s){for(var i in s){s[i].loadedInfo=!0,c.getInstance().updateCache(s[i]);var n=e.get(s[i].id);n&&(e.remove(n.id),e.updateCache(n))}C.getProfile({success:function(){t.success&&t.success(!0)}})}}):C.getProfile({success:function(){t.success&&t.success(!0)}})},error:function(e){YYIMChat.log("拉取摘要失败",0,e),t.error&&t.error(e)}})}})},m.prototype.updateCache=function(t){if(t&&t.id&&t.id!=YYIMChat.getUserID()){var e,i,n=E.RECENT_TYPE.UNFOLDED;switch(t.type){case E.CHAT_TYPE.GROUP_CHAT:e=s.getInstance().updateCache({id:t.id}),!e.loadedInfo&&t&&t.from&&(e=s.getInstance().updateCache({id:t.id,name:t.from.name}));break;case E.CHAT_TYPE.PUB_ACCOUNT:e=c.getInstance().updateCache({id:t.id}),!e.loadedInfo&&t&&t.from&&(e=c.getInstance().updateCache({id:t.id,name:t.from.name,group:t.from.group}));break;default:e=p.getInstance().updateCache({id:t.id}),!e.loadedInfo&&t&&t.from&&(e=p.getInstance().updateCache({id:t.id,name:t.from.name}))}if(!e)return;if(e.group&&t.type===E.CHAT_TYPE.PUB_ACCOUNT?(n=E.RECENT_TYPE.FOLDED,i=this.get(encodeURIComponent(e.group))):(i=this.get(e.id),i&&YYIMUtil.isWhateType(t.stick,"Boolean")&&t.stick!==i.stick&&t.stick===e.stick&&(i.stick=t.stick,t=i,this.remove(t.id),i=null)),i){n==E.RECENT_TYPE.FOLDED?i.build({id:encodeURIComponent(e.group),name:e.group,entity:t}):i.build(t);var o=this.recentNormalList;i.stick&&(o=this.recentTopList),t.sort&&o.indexOf(i)>-1&&0!=o.indexOf(i)&&(o.splice(o.indexOf(i),1),o.unshift(i))}else{i=n==E.RECENT_TYPE.FOLDED?new l({id:encodeURIComponent(e.group),name:e.group,entity:t}):new f(t),this.set(i.id,i);var o=this.recentNormalList;i.stick&&(o=this.recentTopList),o.unshift(i)}return this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList),this.countNotices(i),i}},m.prototype.updateFoldedAttibutes=function(t){this.forEach(function(t,e,s){e.type==E.RECENT_TYPE.FOLDED&&e.getSpaceAttributes()})},m.prototype.countNotices=function(t){t&&t.spaceId&&I.getInstance().updateCache({id:t.spaceId});var e=0,s=this.getAllRecentList();I.getInstance().forEach(function(t,i){i.build({unReadedNum:0,unReadedTotalNum:0});for(var n in s)s[n].from&&s[n].type!=E.RECENT_TYPE.FOLDED&&(s[n].from.pubType&&s[n].from.pubType!=g.PUBACCOUNTTYPE.PUBACCOUNT.name||(s[n].spaceId?s[n].spaceId==i.id&&(i.unReadedNum+=s[n].notice,i.unReadedTotalNum+=s[n].notice):i.unReadedTotalNum+=s[n].notice));if(e+=i.unReadedNum,i.unReadedNum>0){var o={};o[i.id]=i.unReadedNum,jQuery(document).trigger("getSpaceMsgNum.EucIM",[o])}}),I.getInstance().forEach(function(t,s){s.build({unReadedOtherTotalNum:e-s.unReadedNum})})},m.prototype.remove=function(t){if(t){var e=this.get(t);e&&(delete this.list[t],this.recentTopList.indexOf(e)>-1&&this.recentTopList.splice(this.recentTopList.indexOf(e),1),this.recentNormalList.indexOf(e)>-1&&this.recentNormalList.splice(this.recentNormalList.indexOf(e),1),this.recentList=this.recentTopList.concat(this.recentNormalList),this.save(),this.countNotices())}},m.prototype.getRecentList=function(){this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList);var t=[];for(var e in this.recentList)this.recentList[e].type==E.RECENT_TYPE.FOLDED?this.recentList[e].spaceIds.indexOf(this.spaceId)>-1&&t.push(this.recentList[e]):this.recentList[e].type!=E.CHAT_TYPE.CHAT&&this.recentList[e].spaceId&&this.recentList[e].spaceId!=this.spaceId||t.push(this.recentList[e]);return t},m.prototype.get=function(t){if(t){var e=this.getAllRecentList();return e[t]}},m.prototype.getAllRecentList=function(){this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList);var t={};for(var e in this.recentList){if(this.recentList[e].type==E.RECENT_TYPE.FOLDED){var s=this.recentList[e].getAllRecentList();for(var i in s)s[i].id&&(t[s[i].id]=s[i])}t[this.recentList[e].id]=this.recentList[e]}return t},m.prototype.queryRecentList=function(t){this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList);var e=[];for(var s in this.recentList)if(this.recentList[s].type==E.RECENT_TYPE.FOLDED)e=e.concat(this.recentList[s].queryRecentList(t));else if(this.recentList[s].type==E.CHAT_TYPE.CHAT||!this.recentList[s].spaceId||this.recentList[s].spaceId==this.spaceId){var i=this.recentList[s].from;(i.name&&i.name.indexOf(t)>-1||i.vcard&&i.vcard.mobile&&i.vcard.mobile.indexOf(t)>-1)&&e.push(this.recentList[s])}return e},m.prototype.getListByChatType=function(t){this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline")),this.recentList=this.recentTopList.concat(this.recentNormalList);var e=[];for(var s in this.recentList)this.recentList[s].type==E.RECENT_TYPE.FOLDED?e=e.concat(this.recentList[s].getListByChatType()):t&&this.recentList[s].type!=t||this.recentList[s].spaceId&&this.recentList[s].spaceId!=this.spaceId||e.push(this.recentList[s]);return e},m.prototype.save=function(){this.recentNormalList.sort(YYIMUtil.array.comparisonDesc("dateline"));var t=this.recentTopList.concat(this.recentNormalList),e=[];for(var s in t){var i=t[s];if(i.id)if(i.type==E.RECENT_TYPE.FOLDED){var n=i.recentTopList.concat(i.recentNormalList);for(var o in n)n[o].id&&e.unshift({id:n[o].id,name:n[o].name,from:{id:n[o].id,name:n[o].from.name,group:n[o].from.group},type:n[o].type,contentType:n[o].contentType,readedVersion:n[o].readedVersion,sessionVersion:n[o].sessionVersion,mute:n[o].mute,stick:n[o].stick,latestState:n[o].showState,dateline:n[o].dateline})}else e.unshift({id:i.id,name:i.name,from:{id:i.id,name:i.from.name,group:i.from.group},type:i.type,contentType:i.contentType,readedVersion:i.readedVersion,sessionVersion:i.sessionVersion,mute:i.mute,stick:i.stick,latestState:i.showState,dateline:i.dateline})}Y.localstorage.setItem("RECENTDATA_"+YYIMChat.getUserNode(),JSON.stringify(e))},m.prototype.destory=function(){this.save(),this.recentTopList.length=0,this.recentNormalList.length=0,this.recentList.length=0,this.spaceId=null,this.clear()},T.prototype.build=function(t){this.id=t.id||this.id,this.name=t.name||this.name,this.type=t.type||this.type||g.SPACETYPE.NORMAL,this.unReadedNum=YYIMUtil.isWhateType(t.unReadedNum,"Number")?t.unReadedNum:this.unReadedNum||0,this.unReadedTotalNum=YYIMUtil.isWhateType(t.unReadedTotalNum,"Number")?t.unReadedTotalNum:this.unReadedTotalNum||0,this.unReadedOtherTotalNum=YYIMUtil.isWhateType(t.unReadedOtherTotalNum,"Number")?t.unReadedOtherTotalNum:this.unReadedOtherTotalNum||0},T.prototype.getRecentManager=function(){return m.getInstance(this.id)},T.prototype.getGroupManager=function(){return s.getInstance(this.id)},T.prototype.getPubAccountManager=function(){return c.getInstance(this.id)},T.prototype.getRosterManager=function(){return p.getInstance()},T.prototype.getMessageManager=function(){return o.getInstance()},T.prototype.getProfileManager=function(){return C},T.prototype.destory=function(){this.getRecentManager().destory(),this.getGroupManager().destory(),this.getPubAccountManager().destory(),this.getRosterManager().destory(),this.getMessageManager().destory()},I.prototype=new t,I.getInstance=function(){return this._instance||(this._instance=new I),this._instance},I.prototype.updateCache=function(t){if(t&&t.id){var e=this.get(t.id);return e?e.build(t):(e=new T(t),this.set(e.id,e)),e}},I.prototype.setBaseUrl=function(t,e){y.ADDRESS=t||y.ADDRESS,y.STATICADDRESS=e||y.STATICADDRESS},I.prototype.getBaseUrl=function(t){return y.ADDRESS},I.prototype.destory=function(){this.updateCache({id:currentSpaceId}).destory()};var Y=function(){return{localstorage:function(){function t(){if("object"==typeof localStorage)return o=!0,localStorage;if("object"==typeof globalStorage)return o=!0,globalStorage[location.host];throw new Error("LocalStorage not available.")}function e(){a&&a.clear()}function s(t,e){a&&a.setItem(t,e)}function i(t){if(a)return a.getItem(t)}function n(t){a&&a.removeItem(t)}var o=!1,a=t();return{enable:o,getLocalStorage:t,setItem:s,getItem:i,removeItem:n,clear:e}}(),event:{addHandler:function(t,e,s){t.addEventListener?t.addEventListener(e,s,!1):t.attachEvent?t.attachEvent("on"+e,s):t["on"+e]=s},removeHandler:function(t,e,s){t.removeEventListener?t.removeEventListener(e,s,!1):t.detachEvent?t.detachEvent("on"+e,s):t["on"+e]=null}},cookie:{get:function(t){if(t)for(var e=document.cookie,s=e.split(";"),i=s.length,n=0;n<i;n++){var o=s[n].split("=");if(decodeURIComponent(o[0].replace(/(^\s+)|(\s+$)/g,""))==t)return decodeURIComponent(o[1])}return null},set:function(t,e,s,i,n,o){var a=encodeURIComponent(t)+"="+encodeURIComponent(e);if(s){var r=new Date((new Date).getTime()+s);a+=";expires="+r.toGMTString()}i&&(a+=";path="+i),n&&(a+=";domain="+n),o&&(a+=";secure"),document.cookie=a},"delete":function(t,e,s,i){Y.cookie.set(t,"",new Date(0),e,s,i)}},array:{isArray:function(t){return Y.isWhateType(t,"Array")},comparisonAsc:function(t){return function(e,s){return e[t]-s[t]}},comparisonDesc:function(t){return function(e,s){return s[t]-e[t]}}},isWhateType:function(t,e){return"Null"===e&&null===t||"Undefined"===e&&void 0===t||"Number"===e&&isFinite(t)||Object.prototype.toString.call(t).slice(8,-1)===e},dom:{convertToArray:function(t){var e=null;try{e=Array.prototype.slice.call(t,0)}catch(s){e=[];for(var i=0,n=t.length;i<n;i++)e.push(t[i])}return e}}}}();return I.getInstance()}();